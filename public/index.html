<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cronos Conductor - AI Agent Orchestration with x402</title>
  <meta name="description" content="AI-powered autonomous payment orchestration using x402 protocol on Cronos EVM">
  <link rel="icon" type="image/svg+xml" href="/logo.svg">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    :root {
      --bg-dark: #000000;
      --bg-card: rgba(18, 18, 18, 0.95);
      --bg-glass: rgba(255, 255, 255, 0.03);
      --border: rgba(255, 255, 255, 0.12);
      --text: #ffffff;
      --text-muted: rgba(255, 255, 255, 0.85);
      --text-dim: rgba(255, 255, 255, 0.7);
      --accent: #ffffff;
      --accent-glow: rgba(255, 255, 255, 0.15);
      --success: #ffffff;
      --warning: #ffffff;
      --error: #999999;
      --cyan: #ffffff;
      --cronos-blue: #333333;
      --cronos-light: #555555;

      /* Typography scale */
      --text-xs: 12px;
      --text-sm: 14px;
      --text-base: 16px;
      --text-lg: 18px;
      --text-xl: 20px;
      --text-2xl: 24px;
      --text-3xl: 30px;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: var(--bg-dark);
      color: var(--text);
      min-height: 100vh;
      font-size: var(--text-base);
      line-height: 1.6;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Responsive typography for large screens */
    @media (min-width: 1400px) {
      :root {
        --text-xs: 13px;
        --text-sm: 15px;
        --text-base: 17px;
        --text-lg: 20px;
        --text-xl: 24px;
        --text-2xl: 28px;
        --text-3xl: 36px;
      }
    }

    .bg-gradient {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: #000000;
      pointer-events: none;
      z-index: 0;
    }

    .container {
      position: relative;
      z-index: 1;
      max-width: 1200px;
      margin: 0 auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 16px 0 24px;
      border-bottom: 1px solid var(--border);
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .logo-icon {
      width: 48px;
      height: 48px;
    }

    .logo-icon svg {
      width: 100%;
      height: 100%;
    }

    .logo-text {
      display: flex;
      flex-direction: column;
    }

    .logo-title {
      font-size: 22px;
      font-weight: 700;
      line-height: 1.1;
    }

    .logo-subtitle {
      font-size: var(--text-xs);
      font-weight: 500;
      color: var(--text-muted);
      letter-spacing: 1px;
      text-transform: uppercase;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .wallet-module {
      position: relative;
    }

    .wallet-pill {
      display: flex;
      align-items: center;
      gap: 10px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 8px 14px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .wallet-pill:hover {
      border-color: rgba(255, 255, 255, 0.3);
      background: rgba(255, 255, 255, 0.05);
    }

    .wallet-pill .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--success);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    .wallet-balance {
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      font-size: var(--text-sm);
      color: var(--text);
    }

    .wallet-chevron {
      color: var(--text-muted);
      font-size: var(--text-xs);
      transition: transform 0.2s;
    }

    .wallet-module.open .wallet-chevron {
      transform: rotate(180deg);
    }

    .wallet-dropdown {
      position: absolute;
      top: calc(100% + 8px);
      right: 0;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      min-width: 240px;
      opacity: 0;
      visibility: hidden;
      transform: translateY(-8px);
      transition: all 0.2s;
      z-index: 100;
      overflow: hidden;
    }

    .wallet-module.open .wallet-dropdown {
      opacity: 1;
      visibility: visible;
      transform: translateY(0);
    }

    .wallet-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
    }

    .wallet-header-balance {
      font-size: var(--text-2xl);
      font-weight: 700;
      font-family: 'JetBrains Mono', monospace;
      color: var(--text);
    }

    .wallet-header-label {
      font-size: var(--text-xs);
      color: var(--text-muted);
      margin-top: 4px;
    }

    .wallet-address-row {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      background: rgba(0,0,0,0.2);
    }

    .wallet-full-address {
      font-family: 'JetBrains Mono', monospace;
      font-size: var(--text-xs);
      color: var(--text-muted);
      flex: 1;
    }

    .wallet-actions {
      padding: 8px;
    }

    .wallet-action {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 14px;
      border-radius: 8px;
      cursor: pointer;
      transition: background 0.15s;
      font-size: var(--text-sm);
      color: var(--text);
      border: none;
      background: none;
      width: 100%;
      text-align: left;
      font-family: 'Inter', sans-serif;
    }

    .wallet-action:hover {
      background: rgba(255,255,255,0.05);
      color: var(--text);
    }

    .wallet-action.danger:hover {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error);
    }

    .wallet-action-icon {
      width: 18px;
      text-align: center;
      opacity: 0.7;
    }

    .copy-toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(20px);
      background: var(--text);
      color: #000;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: var(--text-sm);
      font-weight: 600;
      opacity: 0;
      transition: all 0.3s;
      z-index: 1000;
    }

    .copy-toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    .x402-badge {
      background: rgba(245, 158, 11, 0.15);
      border: 1px solid rgba(245, 158, 11, 0.3);
      color: var(--warning);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 600;
    }

    .main-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 24px;
      flex: 1;
      margin-top: 24px;
      min-height: 0;
    }

    .sidebar {
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 20px;
      height: fit-content;
    }

    .sidebar-title {
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 1px;
      margin-bottom: 16px;
    }

    /* Flow Diagram */
    .flow-diagram {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      margin-bottom: 20px;
    }

    .flow-step {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 0;
    }

    .flow-step:not(:last-child) {
      border-bottom: 1px dashed var(--border);
    }

    .flow-icon {
      width: 28px;
      height: 28px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .flow-icon.user { background: #333; }
    .flow-icon.conductor { background: #444; }
    .flow-icon.agents { background: #555; }

    .flow-text {
      display: flex;
      flex-direction: column;
    }

    .flow-text strong {
      color: var(--text);
      font-size: var(--text-sm);
    }

    .flow-sub {
      font-size: var(--text-xs);
      color: var(--text-muted);
    }

    .flow-arrow {
      color: var(--text-muted);
      font-size: var(--text-xs);
      padding-left: 38px;
      opacity: 0.5;
    }

    .agent-mini {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      margin-bottom: 6px;
      transition: all 0.2s;
    }

    .agent-mini.active {
      border-color: var(--accent);
      background: rgba(139, 92, 246, 0.1);
    }

    .agent-mini.success {
      border-color: var(--success);
    }

    .agent-mini-icon {
      width: 28px;
      height: 28px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      flex-shrink: 0;
    }

    .agent-mini-icon.arbitrage { background: #333; }
    .agent-mini-icon.sentiment { background: #444; }
    .agent-mini-icon.risk { background: #555; }
    .agent-mini-icon.audit { background: #666; }
    .agent-mini-icon.executor { background: #777; }

    .agent-mini-info { flex: 1; min-width: 0; }
    .agent-mini-name { font-size: var(--text-sm); font-weight: 600; }
    .agent-mini-price { font-size: var(--text-xs); color: var(--text-muted); font-family: 'JetBrains Mono', monospace; }

    .stats-box {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }

    .stat-row {
      display: flex;
      justify-content: space-between;
      font-size: var(--text-sm);
      padding: 6px 0;
    }

    .stat-label { color: var(--text-muted); }
    .stat-value { font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--text); }
    .stat-value.warning { color: var(--text-muted); }
    .stat-value.success { color: var(--text); }

    /* Chat Area */
    .chat-area {
      display: flex;
      flex-direction: column;
      background: var(--bg-glass);
      backdrop-filter: blur(20px);
      border: 1px solid var(--border);
      border-radius: 16px;
      overflow: hidden;
    }

    .chat-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .conductor-avatar {
      width: 44px;
      height: 44px;
      background: #333;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 22px;
    }

    .conductor-info h2 { font-size: var(--text-lg); font-weight: 600; }
    .conductor-info p { font-size: var(--text-sm); color: var(--text-muted); }

    .conductor-fee {
      margin-left: auto;
      background: rgba(255, 255, 255, 0.05);
      border: 1px solid rgba(255, 255, 255, 0.1);
      padding: 6px 12px;
      border-radius: 8px;
      font-size: var(--text-xs);
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
    }

    .chat-messages {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      min-height: 400px;
      max-height: 500px;
    }

    .message {
      max-width: 85%;
      animation: messageIn 0.3s ease-out;
    }

    @keyframes messageIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.user { align-self: flex-end; }
    .message.conductor { align-self: flex-start; }

    .message-content {
      padding: 16px 20px;
      border-radius: 16px;
      font-size: var(--text-base);
      line-height: 1.6;
    }

    .message.user .message-content {
      background: var(--accent);
      color: #000;
      border-bottom-right-radius: 4px;
    }

    .message.conductor .message-content {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }

    .message-plan {
      margin-top: 12px;
      padding: 16px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border);
      border-radius: 12px;
    }

    .plan-header {
      font-size: var(--text-xs);
      font-weight: 600;
      color: var(--text);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 10px;
    }

    .plan-agents {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }

    .plan-agent-chip {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      background: var(--bg-card);
      border-radius: 6px;
      font-size: var(--text-sm);
    }

    .plan-costs {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 8px;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid var(--border);
    }

    .plan-cost-item {
      text-align: center;
    }

    .plan-cost-label {
      font-size: var(--text-xs);
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .plan-cost-value {
      font-family: 'JetBrains Mono', monospace;
      font-size: var(--text-sm);
      font-weight: 600;
      color: var(--text-muted);
    }

    /* Protocol Boxes - Shows x402, A2A, Groq visually */
    .protocol-box {
      margin: 10px 0;
      border-radius: 10px;
      overflow: hidden;
      border: 1px solid var(--border);
      background: rgba(0,0,0,0.3);
    }

    .protocol-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      font-size: var(--text-xs);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .protocol-box.a2a .protocol-header { background: rgba(255, 255, 255, 0.05); color: var(--text-muted); }
    .protocol-box.x402 .protocol-header { background: rgba(255, 255, 255, 0.05); color: var(--text-muted); }
    .protocol-box.groq .protocol-header { background: rgba(255, 255, 255, 0.05); color: var(--text-muted); }

    .protocol-icon { font-size: var(--text-sm); }
    .model-tag { margin-left: auto; font-size: var(--text-xs); padding: 2px 6px; background: rgba(0,0,0,0.3); border-radius: 4px; }

    .protocol-body {
      padding: 10px 12px;
      font-family: 'JetBrains Mono', monospace;
      font-size: var(--text-xs);
    }

    .agent-tag {
      display: inline-block;
      padding: 4px 10px;
      background: var(--bg-card);
      border-radius: 6px;
      margin: 2px;
      font-size: var(--text-xs);
    }

    .header-row {
      display: flex;
      gap: 8px;
      padding: 3px 0;
    }

    .header-key { color: var(--text-muted); }
    .header-val { color: var(--text); }
    .header-link { color: #6bb3ff; text-decoration: none; transition: color 0.2s; }
    .header-link:hover { color: #9dd1ff; text-decoration: underline; }
    .header-val.status-402 { color: var(--text-muted); font-weight: 600; }
    .header-val.status-200 { color: var(--text); font-weight: 600; }
    .header-row.result { margin-top: 6px; padding-top: 6px; border-top: 1px dashed var(--border); }

    .ai-reasoning { color: var(--text-muted); line-height: 1.5; font-family: 'Inter', sans-serif; font-size: var(--text-sm); }

    .cost-summary {
      display: flex;
      gap: 16px;
      padding: 10px 12px;
      background: rgba(0,0,0,0.2);
      border-radius: 8px;
      margin: 10px 0;
      font-size: var(--text-xs);
    }

    .cost-item {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .cost-item span:first-child { color: var(--text-muted); font-size: var(--text-xs); text-transform: uppercase; }
    .cost-item span:last-child { color: var(--text-muted); font-weight: 600; font-family: 'JetBrains Mono', monospace; }
    .cost-item.total span:last-child { color: var(--text); }

    .plan-reasoning {
      font-size: var(--text-sm);
      color: var(--text-muted);
      margin-top: 8px;
      font-style: italic;
    }

    .message-results { margin-top: 12px; }

    .result-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px;
      margin-bottom: 8px;
    }

    .result-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .result-card-agent {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: var(--text-sm);
      font-weight: 600;
    }

    .result-card-badges {
      display: flex;
      gap: 6px;
      align-items: center;
    }

    .llm-badge {
      font-size: var(--text-xs);
      padding: 3px 6px;
      background: rgba(255, 255, 255, 0.1);
      color: var(--text-muted);
      border-radius: 4px;
    }

    .cost-badge {
      font-size: var(--text-xs);
      color: var(--text-muted);
      font-family: 'JetBrains Mono', monospace;
    }

    .result-ai {
      margin-top: 10px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      font-size: var(--text-sm);
      line-height: 1.5;
      color: var(--text-muted);
    }

    .ai-label {
      color: var(--success);
      font-weight: 600;
    }

    .result-metrics {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 8px;
    }

    .result-metric {
      padding: 8px;
      background: var(--bg-glass);
      border-radius: 6px;
    }

    .result-metric-label {
      font-size: var(--text-xs);
      color: var(--text-muted);
      text-transform: uppercase;
    }

    .result-metric-value {
      font-size: var(--text-sm);
      font-weight: 600;
      font-family: 'JetBrains Mono', monospace;
    }

    .result-metric-value.success { color: var(--text); }
    .result-metric-value.warning { color: var(--text-muted); }
    .result-metric-value.error { color: var(--text-dim); }

    /* Execute Swap Section */
    .execute-swap-section {
      margin-top: 16px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(34, 197, 94, 0.1), rgba(34, 197, 94, 0.05));
      border: 1px solid rgba(34, 197, 94, 0.3);
      border-radius: 10px;
    }

    .swap-details {
      display: flex;
      gap: 20px;
      margin-bottom: 12px;
      font-size: var(--text-sm);
      color: var(--text-muted);
    }

    .swap-details strong {
      color: #22c55e;
    }

    .swap-controls {
      display: flex;
      gap: 12px;
      align-items: center;
      margin-bottom: 10px;
    }

    .swap-amount-input {
      width: 120px;
      padding: 10px 12px;
      background: rgba(0, 0, 0, 0.3);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 8px;
      color: var(--text);
      font-family: 'JetBrains Mono', monospace;
      font-size: var(--text-sm);
    }

    .swap-amount-input:focus {
      outline: none;
      border-color: #22c55e;
    }

    .execute-swap-btn {
      flex: 1;
      padding: 12px 20px;
      background: linear-gradient(135deg, #22c55e, #16a34a);
      border: none;
      border-radius: 8px;
      color: #fff;
      font-weight: 600;
      font-size: var(--text-sm);
      cursor: pointer;
      transition: all 0.2s;
    }

    .execute-swap-btn:hover {
      background: linear-gradient(135deg, #16a34a, #15803d);
      transform: translateY(-1px);
    }

    .swap-warning {
      font-size: 11px;
      color: #f59e0b;
      opacity: 0.8;
    }

    .message-summary {
      margin-top: 12px;
      padding: 16px;
      background: linear-gradient(135deg, rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.03));
      border: 1px solid rgba(255, 255, 255, 0.15);
      border-radius: 12px;
      font-size: var(--text-sm);
      line-height: 1.7;
      white-space: pre-line;
    }

    .message-summary strong {
      color: #fff;
      font-weight: 600;
    }

    .conductor-recommendation {
      margin-top: 16px;
      padding: 14px;
      background: rgba(107, 179, 255, 0.1);
      border: 1px solid rgba(107, 179, 255, 0.3);
      border-radius: 10px;
      border-left: 3px solid #6bb3ff;
    }

    .conductor-recommendation-title {
      font-weight: 600;
      color: #6bb3ff;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .typing-indicator {
      display: flex;
      gap: 4px;
      padding: 14px 18px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 16px;
      border-bottom-left-radius: 4px;
      width: fit-content;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      background: var(--text-muted);
      border-radius: 50%;
      animation: typing 1.4s infinite;
    }

    .typing-dot:nth-child(2) { animation-delay: 0.2s; }
    .typing-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes typing {
      0%, 60%, 100% { transform: translateY(0); opacity: 0.5; }
      30% { transform: translateY(-4px); opacity: 1; }
    }

    .chat-input-area {
      padding: 16px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
    }

    .chat-input {
      flex: 1;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 14px 18px;
      color: var(--text);
      font-size: var(--text-base);
      font-family: inherit;
      resize: none;
      outline: none;
      transition: border-color 0.2s;
    }

    .chat-input:focus { border-color: var(--accent); }
    .chat-input::placeholder { color: var(--text-muted); }

    .send-btn {
      background: #fff;
      border: none;
      border-radius: 12px;
      padding: 14px 24px;
      color: #000;
      font-size: var(--text-base);
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }

    .send-btn:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 8px 30px rgba(255, 255, 255, 0.1);
    }

    .send-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .quick-actions {
      padding: 12px 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .quick-btn {
      padding: 8px 14px;
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 8px;
      color: var(--text-muted);
      font-size: var(--text-sm);
      cursor: pointer;
      font-family: inherit;
      transition: all 0.2s;
    }

    .quick-btn:hover {
      border-color: var(--accent);
      color: var(--text);
    }

    .disclaimer {
      text-align: center;
      padding: 20px;
      font-size: var(--text-xs);
      color: var(--text-muted);
      border-top: 1px solid var(--border);
      margin-top: 24px;
    }

    .disclaimer span {
      color: var(--text-muted);
      font-weight: 600;
    }

    @media (max-width: 900px) {
      .main-layout { grid-template-columns: 1fr; }
      .sidebar { display: none; }
    }
  </style>
</head>
<body>
  <div class="bg-gradient"></div>

  <div class="container">
    <header>
      <div class="logo">
        <div class="logo-icon">
          <img src="/logo.svg" alt="Cronos Conductor" width="48" height="48">
        </div>
        <div class="logo-text">
          <div class="logo-title">Cronos Conductor</div>
          <div class="logo-subtitle">AI Agent Orchestration</div>
        </div>
      </div>
      <div class="header-right">
        <div class="wallet-module" id="walletModule">
          <div class="wallet-pill" id="walletPill" onclick="handleWalletClick()">
            <span class="status-dot" id="statusDot"></span>
            <span class="wallet-balance" id="walletBalance">Connect Wallet</span>
            <span class="wallet-chevron" id="walletChevron">‚ñº</span>
          </div>
          <div class="wallet-dropdown" id="walletDropdown">
            <div class="wallet-header">
              <div class="wallet-header-balance" id="walletBalanceFull">0.0000 CRO</div>
              <div class="wallet-header-label" id="walletLabel">EOA Wallet</div>
            </div>
            <div class="wallet-address-row">
              <span class="wallet-full-address" id="walletFullAddress">Not connected</span>
            </div>
            <div class="wallet-actions">
              <button class="wallet-action" onclick="copyAddress()">
                <span class="wallet-action-icon">üìã</span>
                Copy Address
              </button>
              <button class="wallet-action" onclick="viewExplorer()">
                <span class="wallet-action-icon">üîó</span>
                View on Explorer
              </button>
              <button class="wallet-action" onclick="refreshBalance()">
                <span class="wallet-action-icon">üîÑ</span>
                Refresh Balance
              </button>
              <button class="wallet-action danger" id="disconnectBtn" onclick="disconnectWallet()">
                <span class="wallet-action-icon">‚èª</span>
                Disconnect
              </button>
            </div>
          </div>
        </div>
      </div>
      <div class="copy-toast" id="copyToast">Address copied!</div>
    </header>

    <div class="main-layout">
      <div class="sidebar">
        <!-- Protocol Stack -->
        <div class="sidebar-title">Smart Wallet Flow</div>
        <div class="flow-diagram">
          <div class="flow-step">
            <div class="flow-icon user">üîê</div>
            <div class="flow-text">
              <strong>Your EOA</strong>
              <span class="flow-sub">Signs authorization</span>
            </div>
          </div>
          <div class="flow-arrow">‚Üì controls</div>
          <div class="flow-step">
            <div class="flow-icon" style="background: #2a4858;">üìù</div>
            <div class="flow-text">
              <strong>Smart Wallet</strong>
              <span class="flow-sub">Counterfactual (CREATE2)</span>
            </div>
          </div>
          <div class="flow-arrow">‚Üì pays</div>
          <div class="flow-step">
            <div class="flow-icon conductor">üéñÔ∏è</div>
            <div class="flow-text">
              <strong>Conductor</strong>
              <span class="flow-sub">Orchestrator</span>
            </div>
          </div>
          <div class="flow-arrow">‚Üì pays</div>
          <div class="flow-step">
            <div class="flow-icon agents">ü§ñ</div>
            <div class="flow-text">
              <strong>Sub-Agents</strong>
              <span class="flow-sub">x402 Services</span>
            </div>
          </div>
        </div>

        <!-- Sub-Agents -->
        <div class="sidebar-title">Sub-Agents</div>
        <div id="agentList">
          <div class="agent-mini" id="mini-arbitrage">
            <div class="agent-mini-icon arbitrage">üìà</div>
            <div class="agent-mini-info">
              <div class="agent-mini-name">Arbitrage</div>
              <div class="agent-mini-price">0.08 CRO</div>
            </div>
          </div>
          <div class="agent-mini" id="mini-sentiment">
            <div class="agent-mini-icon sentiment">üêã</div>
            <div class="agent-mini-info">
              <div class="agent-mini-name">Sentiment</div>
              <div class="agent-mini-price">0.06 CRO</div>
            </div>
          </div>
          <div class="agent-mini" id="mini-risk">
            <div class="agent-mini-icon risk">üìä</div>
            <div class="agent-mini-info">
              <div class="agent-mini-name">Risk</div>
              <div class="agent-mini-price">0.05 CRO</div>
            </div>
          </div>
          <div class="agent-mini" id="mini-audit">
            <div class="agent-mini-icon audit">üîç</div>
            <div class="agent-mini-info">
              <div class="agent-mini-name">Audit</div>
              <div class="agent-mini-price">0.10 CRO</div>
            </div>
          </div>
          <div class="agent-mini" id="mini-executor">
            <div class="agent-mini-icon executor">‚ö°</div>
            <div class="agent-mini-info">
              <div class="agent-mini-name">Executor</div>
              <div class="agent-mini-price">0.03 CRO</div>
            </div>
          </div>
        </div>

        <div class="stats-box">
          <div class="sidebar-title">Session</div>
          <div class="stat-row">
            <span class="stat-label">Total Spent</span>
            <span class="stat-value warning" id="totalSpent">0.00 CRO</span>
          </div>
          <div class="stat-row">
            <span class="stat-label">Queries</span>
            <span class="stat-value" id="queryCount">0</span>
          </div>
        </div>
      </div>

      <div class="chat-area">
        <div class="chat-header">
          <div class="conductor-avatar">üéñÔ∏è</div>
          <div class="conductor-info">
            <h2>Conductor</h2>
          </div>
          <div class="conductor-fee">Pay-per-use</div>
        </div>

        <div class="chat-messages" id="chatMessages">
          <div class="message conductor">
            <div class="message-content">
              Connect your wallet to get started. You'll get a deterministic Smart Wallet address (CREATE2). I'll analyze your query, show you the agents needed and total cost upfront, then execute once you approve payment. You pay exactly what's needed - no hidden fees.
            </div>
          </div>
        </div>

        <div class="quick-actions">
          <button class="quick-btn" onclick="sendQuick('Market sentiment?')">Sentiment</button>
          <button class="quick-btn" onclick="sendQuick('Arbitrage opportunities')">Arbitrage</button>
          <button class="quick-btn" onclick="sendQuick('Should I buy CRO?')">Buy CRO?</button>
          <button class="quick-btn" onclick="sendQuick('Full analysis')">Full Analysis</button>
        </div>

        <div class="chat-input-area">
          <textarea class="chat-input" id="chatInput" placeholder="Ask anything..." rows="1" onkeydown="handleKey(event)"></textarea>
          <button class="send-btn" id="sendBtn" onclick="send()">‚Üí</button>
        </div>
      </div>
    </div>

    <footer class="disclaimer">
      <span>Cronos Conductor</span> ¬∑ Testnet ¬∑ Not financial advice
    </footer>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.9.0/ethers.umd.min.js"></script>
  <script>
    // ============ CONFIG ============
    const API_BASE = window.location.hostname === 'localhost' ? '' : 'https://cronos-conductor-660587902574.us-central1.run.app';
    const CRONOS_TESTNET = {
      chainId: '0x152', // 338
      chainName: 'Cronos Testnet',
      nativeCurrency: { name: 'TCRO', symbol: 'TCRO', decimals: 18 },
      rpcUrls: ['https://evm-t3.cronos.org'],
      blockExplorerUrls: ['https://explorer.cronos.org/testnet']
    };
    const CONDUCTOR_ADDRESS = '0x15ECEE3445E3C8cf28D4D93fAB50181de728b86d';
    const SMART_WALLET_FACTORY = '0x32537e25eE45e72382320F2abCA8b872c7384d81';
    const CONDUCTOR_FEE = '0.02'; // CRO
    const CHAIN_ID = 338;

    const AGENTS = {
      'agent-arbitrage': { icon: 'üìà', name: 'Arbitrage', cls: 'arbitrage' },
      'agent-sentiment': { icon: 'üêã', name: 'Sentiment', cls: 'sentiment' },
      'agent-risk': { icon: 'üìä', name: 'Risk', cls: 'risk' },
      'agent-audit': { icon: 'üîç', name: 'Audit', cls: 'audit' },
      'agent-executor': { icon: '‚ö°', name: 'Executor', cls: 'executor' }
    };

    // ============ WALLET STATE ============
    let walletAddress = null;  // EOA address
    let smartWalletAddress = null;  // Counterfactual smart wallet
    let walletBalance = 0;
    let smartWalletBalance = 0;
    let isConnected = false;
    let processing = false;
    let totalSpent = 0;
    let queries = 0;
    let paymentNonce = 0;

    // ============ SMART WALLET COMPUTATION ============
    // Compute counterfactual address using CREATE2 (matches Solidity)
    async function computeSmartWalletAddress(owner) {
      // keccak256(abi.encodePacked(owner))
      const salt = ethers.keccak256(ethers.solidityPacked(['address'], [owner]));

      // SmartWallet bytecode hash (from deployed factory)
      // This matches: keccak256(abi.encodePacked(type(SmartWallet).creationCode, abi.encode(owner)))
      const initCodeHash = await getInitCodeHash(owner);

      // CREATE2 address: keccak256(0xff ++ factory ++ salt ++ keccak256(initCode))[12:]
      const computed = ethers.getCreate2Address(SMART_WALLET_FACTORY, salt, initCodeHash);
      return computed;
    }

    // Get init code hash (call factory's getWalletAddress for accuracy)
    async function getInitCodeHash(owner) {
      // For simplicity, we'll call the factory contract
      const iface = new ethers.Interface([
        'function getWalletAddress(address owner) view returns (address)'
      ]);
      const data = iface.encodeFunctionData('getWalletAddress', [owner]);

      try {
        const result = await window.ethereum.request({
          method: 'eth_call',
          params: [{ to: SMART_WALLET_FACTORY, data }, 'latest']
        });
        return ethers.getAddress('0x' + result.slice(26));
      } catch (e) {
        console.error('Failed to get smart wallet address:', e);
        return null;
      }
    }

    // Get smart wallet address from factory
    async function getSmartWalletFromFactory(owner) {
      const iface = new ethers.Interface([
        'function getWalletAddress(address owner) view returns (address)'
      ]);
      const data = iface.encodeFunctionData('getWalletAddress', [owner]);

      try {
        const result = await window.ethereum.request({
          method: 'eth_call',
          params: [{ to: SMART_WALLET_FACTORY, data }, 'latest']
        });
        // Decode address from result
        return ethers.getAddress('0x' + result.slice(26));
      } catch (e) {
        console.error('Failed to get smart wallet address:', e);
        return null;
      }
    }

    // Sign payment authorization
    async function signPaymentAuthorization(to, amount, nonce) {
      // Message: "Authorize payment: [smartWallet] -> [to] for [amount] CRO (nonce: [nonce], chain: [chainId])"
      const amountWei = ethers.parseEther(amount.toString());

      // Create typed data for EIP-712 signing
      const message = ethers.solidityPackedKeccak256(
        ['address', 'address', 'uint256', 'uint256', 'uint256'],
        [smartWalletAddress, to, amountWei, nonce, CHAIN_ID]
      );

      // Sign with personal_sign
      const signature = await window.ethereum.request({
        method: 'personal_sign',
        params: [message, walletAddress]
      });

      return { signature, nonce, amount: amountWei.toString() };
    }

    // ============ WALLET CONNECTION ============
    async function handleWalletClick() {
      if (!isConnected) {
        await connectWallet();
      } else {
        document.getElementById('walletModule').classList.toggle('open');
      }
    }

    async function connectWallet() {
      if (typeof window.ethereum === 'undefined') {
        alert('Please install MetaMask to use this app');
        return;
      }

      try {
        // Request accounts
        const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
        walletAddress = accounts[0];

        // Switch to Cronos Testnet
        try {
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: CRONOS_TESTNET.chainId }]
          });
        } catch (switchError) {
          if (switchError.code === 4902) {
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [CRONOS_TESTNET]
            });
          } else {
            throw switchError;
          }
        }

        // Compute smart wallet address
        smartWalletAddress = await getSmartWalletFromFactory(walletAddress);
        console.log('EOA:', walletAddress);
        console.log('Smart Wallet:', smartWalletAddress);

        isConnected = true;
        await updateWalletUI();

        // Listen for account changes
        window.ethereum.on('accountsChanged', handleAccountChange);
        window.ethereum.on('chainChanged', () => window.location.reload());

      } catch (error) {
        console.error('Connection failed:', error);
        alert('Failed to connect wallet: ' + error.message);
      }
    }

    async function handleAccountChange(accounts) {
      if (accounts.length === 0) {
        disconnectWallet();
      } else {
        walletAddress = accounts[0];
        smartWalletAddress = await getSmartWalletFromFactory(walletAddress);
        updateWalletUI();
      }
    }

    async function updateWalletUI() {
      if (!isConnected || !walletAddress) {
        document.getElementById('walletBalance').textContent = 'Connect Wallet';
        document.getElementById('statusDot').style.background = '#666';
        document.getElementById('walletChevron').style.display = 'none';
        return;
      }

      // Fetch EOA balance
      try {
        const balance = await window.ethereum.request({
          method: 'eth_getBalance',
          params: [walletAddress, 'latest']
        });
        walletBalance = parseInt(balance, 16) / 1e18;
      } catch (e) {
        walletBalance = 0;
      }

      // Fetch Smart Wallet balance (if deployed)
      if (smartWalletAddress) {
        try {
          const balance = await window.ethereum.request({
            method: 'eth_getBalance',
            params: [smartWalletAddress, 'latest']
          });
          smartWalletBalance = parseInt(balance, 16) / 1e18;
        } catch (e) {
          smartWalletBalance = 0;
        }
      }

      // Update UI - show Smart Wallet as primary
      const displayBalance = smartWalletBalance > 0 ? smartWalletBalance : walletBalance;
      document.getElementById('walletBalance').textContent = displayBalance.toFixed(2) + ' CRO';
      document.getElementById('walletBalanceFull').textContent = displayBalance.toFixed(4) + ' CRO';

      // Show smart wallet address if available
      if (smartWalletAddress) {
        document.getElementById('walletFullAddress').innerHTML = `
          <div style="margin-bottom: 4px;"><span style="color: #888;">Smart:</span> ${smartWalletAddress.slice(0,8)}...${smartWalletAddress.slice(-6)}</div>
          <div><span style="color: #666;">EOA:</span> ${walletAddress.slice(0,8)}...${walletAddress.slice(-6)}</div>
        `;
        document.getElementById('walletLabel').textContent = 'Smart Wallet';
      } else {
        document.getElementById('walletFullAddress').textContent = walletAddress;
        document.getElementById('walletLabel').textContent = 'EOA Wallet';
      }

      document.getElementById('statusDot').style.background = '#fff';
      document.getElementById('walletChevron').style.display = 'inline';
    }

    function disconnectWallet() {
      isConnected = false;
      walletAddress = null;
      smartWalletAddress = null;
      walletBalance = 0;
      smartWalletBalance = 0;
      document.getElementById('walletBalance').textContent = 'Connect Wallet';
      document.getElementById('walletBalanceFull').textContent = '0.0000 CRO';
      document.getElementById('walletFullAddress').textContent = 'Not connected';
      document.getElementById('walletLabel').textContent = 'Not connected';
      document.getElementById('statusDot').style.background = '#666';
      document.getElementById('walletChevron').style.display = 'none';
      document.getElementById('walletModule').classList.remove('open');
    }

    async function refreshBalance() {
      await updateWalletUI();
      document.getElementById('walletModule').classList.remove('open');
    }

    function copyAddress() {
      const addr = smartWalletAddress || walletAddress;
      if (addr) {
        navigator.clipboard.writeText(addr);
        const toast = document.getElementById('copyToast');
        toast.textContent = smartWalletAddress ? 'Smart Wallet address copied!' : 'Address copied!';
        toast.classList.add('show');
        setTimeout(() => toast.classList.remove('show'), 2000);
      }
      document.getElementById('walletModule').classList.remove('open');
    }

    function viewExplorer() {
      const addr = smartWalletAddress || walletAddress;
      if (addr) {
        window.open('https://explorer.cronos.org/testnet/address/' + addr, '_blank');
      }
      document.getElementById('walletModule').classList.remove('open');
    }

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const mod = document.getElementById('walletModule');
      if (!mod.contains(e.target)) mod.classList.remove('open');
    });

    // ============ PAYMENT FUNCTIONS ============
    // Option 1: Direct payment from EOA (simple, works now)
    async function payDirectFromEOA(amount) {
      if (!isConnected || !walletAddress) {
        throw new Error('Please connect your wallet first');
      }

      const amountWei = '0x' + Math.floor(parseFloat(amount) * 1e18).toString(16);

      // Send payment to conductor
      const txHash = await window.ethereum.request({
        method: 'eth_sendTransaction',
        params: [{
          from: walletAddress,
          to: CONDUCTOR_ADDRESS,
          value: amountWei,
          gas: '0x5208' // 21000
        }]
      });

      return txHash;
    }

    // Option 2: Sign authorization for smart wallet payment
    async function signSmartWalletPayment(amount) {
      if (!isConnected || !walletAddress || !smartWalletAddress) {
        throw new Error('Please connect your wallet first');
      }

      const amountWei = ethers.parseEther(amount.toString());

      // Create authorization message
      const message = ethers.solidityPackedKeccak256(
        ['address', 'address', 'uint256', 'uint256', 'uint256'],
        [smartWalletAddress, CONDUCTOR_ADDRESS, amountWei, paymentNonce, CHAIN_ID]
      );

      // Sign with personal_sign (EIP-191)
      const signature = await window.ethereum.request({
        method: 'personal_sign',
        params: [message, walletAddress]
      });

      const auth = {
        smartWallet: smartWalletAddress,
        owner: walletAddress,
        to: CONDUCTOR_ADDRESS,
        amount: amountWei.toString(),
        nonce: paymentNonce,
        chainId: CHAIN_ID,
        signature: signature
      };

      paymentNonce++;
      return auth;
    }

    // Main payment function - uses direct EOA payment for now
    // (Smart wallet execution requires backend relayer)
    async function payForService(amount) {
      // For hackathon demo: use direct EOA payment
      // In production: would use smart wallet with signed authorization
      return await payDirectFromEOA(amount);
    }

    // ============ REAL MAINNET SWAP EXECUTION ============
    const CRONOS_MAINNET = {
      chainId: '0x19', // 25
      chainName: 'Cronos Mainnet',
      nativeCurrency: { name: 'CRO', symbol: 'CRO', decimals: 18 },
      rpcUrls: ['https://evm.cronos.org'],
      blockExplorerUrls: ['https://explorer.cronos.org']
    };

    async function executeRealSwap(amountCRO, tokenOut = 'USDC') {
      if (!isConnected || !walletAddress) {
        alert('Please connect your wallet first');
        return;
      }

      // Confirm with user - this is REAL MONEY
      const confirmed = confirm(
        `‚ö†Ô∏è REAL MAINNET TRADE ‚ö†Ô∏è\n\n` +
        `You are about to swap ${amountCRO} CRO for ${tokenOut} on Cronos MAINNET.\n` +
        `This uses REAL money!\n\n` +
        `Continue?`
      );
      if (!confirmed) return;

      try {
        // Switch to Cronos Mainnet
        try {
          await window.ethereum.request({
            method: 'wallet_switchEthereumChain',
            params: [{ chainId: CRONOS_MAINNET.chainId }]
          });
        } catch (switchError) {
          if (switchError.code === 4902) {
            await window.ethereum.request({
              method: 'wallet_addEthereumChain',
              params: [CRONOS_MAINNET]
            });
          } else {
            throw switchError;
          }
        }

        // Get swap transaction from backend
        const res = await fetch(API_BASE + '/api/swap/build', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            amountIn: amountCRO,
            tokenOut,
            slippageBps: 100, // 1%
            userAddress: walletAddress
          })
        });

        const data = await res.json();
        if (!data.success) {
          alert('Failed to build swap: ' + data.error);
          return;
        }

        // Show swap details
        const proceed = confirm(
          `Swap Details:\n\n` +
          `Input: ${data.swap.amountIn}\n` +
          `Expected Output: ${data.swap.expectedOutput}\n` +
          `Minimum Output: ${data.swap.minimumOutput}\n` +
          `Slippage: ${data.swap.slippage}\n\n` +
          `Sign transaction in MetaMask?`
        );
        if (!proceed) return;

        // Execute the swap
        const txHash = await window.ethereum.request({
          method: 'eth_sendTransaction',
          params: [{
            from: walletAddress,
            to: data.transaction.to,
            value: '0x' + BigInt(data.transaction.value).toString(16),
            data: data.transaction.data,
            gas: '0x' + parseInt(data.transaction.gasLimit).toString(16)
          }]
        });

        alert(`Swap submitted!\n\nTx: ${txHash}\n\nView on explorer: https://explorer.cronos.org/tx/${txHash}`);

        // Switch back to testnet
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: CRONOS_TESTNET.chainId }]
        });

        return txHash;
      } catch (e) {
        console.error('Swap failed:', e);
        alert('Swap failed: ' + e.message);
      }
    }

    // ============ MAIN SEND FUNCTION ============
    function handleKey(e) {
      if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); send(); }
    }

    function sendQuick(text) {
      document.getElementById('chatInput').value = text;
      send();
    }

    async function send() {
      const input = document.getElementById('chatInput');
      const goal = input.value.trim();
      if (!goal || processing) return;

      // Check wallet connection
      if (!isConnected) {
        addMsg('conductor', 'Please connect your wallet first to use the service.');
        return;
      }

      processing = true;
      input.value = '';
      document.getElementById('sendBtn').disabled = true;

      addMsg('user', goal);
      const typingId = showTyping();
      resetAgents();

      try {
        // Step 1: Get quote first (which agents + total cost)
        const quoteRes = await fetch(API_BASE + '/api/conductor/plan', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ goal })
        });
        const quote = await quoteRes.json();

        if (!quote.plan || !quote.breakdown) {
          throw new Error('Failed to get quote');
        }

        // Calculate total cost user needs to pay
        const totalCost = quote.breakdown.totalCost.replace(' CRO', '');

        removeTyping(typingId);

        // Show quote to user
        addMsg('conductor', `Planning complete! Agents needed: ${quote.plan.agents.map(a => AGENTS[a]?.name || a).join(', ')}. Total cost: **${totalCost} CRO**. Requesting payment...`, false);

        const typingId2 = showTyping();

        // Step 2: User pays FULL cost from their wallet
        const txHash = await payForService(totalCost);

        removeTyping(typingId2);
        const typingId3 = showTyping();

        // Step 3: Execute via Conductor (with tx hash as proof)
        const res = await fetch(API_BASE + '/api/x402/conductor', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Payment': txHash,
            'X-Payer': walletAddress,
            'X-Smart-Wallet': smartWalletAddress || ''
          },
          body: JSON.stringify({
            goal,
            payer: walletAddress,
            smartWallet: smartWalletAddress,
            txHash,
            quotedCost: totalCost
          })
        });

        const data = await res.json();
        removeTyping(typingId3);

        // Highlight used agents
        if (data.plan?.agents) {
          data.plan.agents.forEach(id => {
            const r = data.results?.find(x => x.agent === id);
            setAgent(id, r?.status === 'success' ? 'success' : 'active');
          });
        }

        // Build response
        let html = ``;

        // Payment confirmation - show x402 protocol details
        const explorerBase = 'https://explorer.cronos.org/testnet';
        html += `
          <div class="protocol-box x402">
            <div class="protocol-header">
              <span class="protocol-icon">üí∞</span>
              <span class="protocol-name">x402 Payment</span>
              <span class="model-tag" style="background: #2d5a27;">VERIFIED</span>
            </div>
            <div class="protocol-body">
              <div class="header-row"><span class="header-key">Protocol:</span><span class="header-val">HTTP 402 Payment Required</span></div>
              <div class="header-row"><span class="header-key">Amount:</span><span class="header-val" style="color: #6bb3ff;">${totalCost} CRO</span></div>
              <div class="header-row"><span class="header-key">Tx Hash:</span><a href="${explorerBase}/tx/${txHash}" target="_blank" class="header-link">${txHash.slice(0,10)}...${txHash.slice(-8)}</a></div>
              <div class="header-row"><span class="header-key">Payer:</span><a href="${explorerBase}/address/${walletAddress}" target="_blank" class="header-link">${walletAddress.slice(0,6)}...${walletAddress.slice(-4)}</a></div>
              <div class="header-row"><span class="header-key">Recipient:</span><span class="header-val">0x15EC...86d (Conductor)</span></div>
              <div class="header-row"><span class="header-key">Network:</span><span class="header-val">Cronos Testnet (338)</span></div>
            </div>
          </div>
        `;

        // A2A Discovery
        if (data.plan?.agents) {
          html += `
            <div class="protocol-box a2a">
              <div class="protocol-header">
                <span class="protocol-icon">üîó</span>
                <span class="protocol-name">A2A Discovery</span>
              </div>
              <div class="protocol-body">
                ${data.plan.agents.map(id => `<span class="agent-tag">${AGENTS[id]?.name || id}</span>`).join('')}
              </div>
            </div>
          `;
        }

        // Groq AI
        if (data.plan) {
          html += `
            <div class="protocol-box groq">
              <div class="protocol-header">
                <span class="protocol-icon">üß†</span>
                <span class="protocol-name">Groq AI</span>
                <span class="model-tag">llama-3.1-8b</span>
              </div>
              <div class="protocol-body">
                <div class="ai-reasoning">${data.plan.reasoning}</div>
              </div>
            </div>
          `;
        }

        // Cost breakdown - user pays everything upfront
        if (data.costs) {
          html += `
            <div class="cost-summary">
              <div class="cost-item"><span>Conductor Fee</span><span>${data.costs.conductorFee}</span></div>
              <div class="cost-item"><span>Sub-Agents</span><span>${data.costs.subAgentsPaid}</span></div>
              <div class="cost-item total"><span>You Paid</span><span style="color: #6bb3ff;">${data.costs.totalCost}</span></div>
            </div>
          `;
        }

        // Results
        if (data.results?.length > 0) {
          html += `<div class="message-results">`;
          for (const r of data.results) {
            if (r.status !== 'success') continue;
            const a = AGENTS[r.agent];
            const m = getMetrics(r);
            const ai = r.data?.aiAnalysis;
            html += `
              <div class="result-card">
                <div class="result-card-header">
                  <div class="result-card-agent">${a?.icon||'ü§ñ'} ${r.name}</div>
                  <div class="result-card-badges">
                    <span class="llm-badge">üß† Groq</span>
                    <span class="cost-badge">${r.cost}</span>
                  </div>
                </div>
                <div class="result-metrics">
                  ${m.map(x => `
                    <div class="result-metric">
                      <div class="result-metric-label">${x.label}</div>
                      <div class="result-metric-value ${x.cls||''}">${x.value}</div>
                    </div>
                  `).join('')}
                </div>
                ${ai?.analysis ? `<div class="result-ai"><span class="ai-label">AI Analysis:</span> ${ai.analysis.substring(0, 200)}${ai.analysis.length > 200 ? '...' : ''}</div>` : ''}
                ${r.agent === 'agent-executor' && r.data?.bestRoute ? `
                  <div class="execute-swap-section">
                    <div class="swap-details">
                      <span>Route: <strong>${r.data.bestRoute.dex}</strong></span>
                      <span>Path: ${r.data.bestRoute.path || 'CRO ‚Üí USDC'}</span>
                    </div>
                    <div class="swap-controls">
                      <input type="number" id="swapAmountInput" class="swap-amount-input" placeholder="Amount CRO" value="1" min="0.01" step="0.1">
                      <button class="execute-swap-btn" onclick="executeRealSwap(document.getElementById('swapAmountInput').value)">
                        ‚ö° Execute Swap on Mainnet
                      </button>
                    </div>
                    <div class="swap-warning">‚ö†Ô∏è Real mainnet transaction - uses actual CRO</div>
                  </div>
                ` : ''}
              </div>
            `;
          }
          html += `</div>`;
        }

        // Summary with formatted markdown
        if (data.summary) {
          // Convert markdown **text** to <strong>text</strong>
          let formattedSummary = data.summary.replace(/\*\*([^*]+)\*\*/g, '<strong>$1</strong>');

          // Check if there's a recommendation section and style it specially
          if (formattedSummary.includes("Conductor's Recommendation")) {
            const parts = formattedSummary.split(/<strong>üéØ Conductor's Recommendation:<\/strong>/);
            if (parts.length === 2) {
              html += `<div class="message-summary">${parts[0]}</div>`;
              html += `
                <div class="conductor-recommendation">
                  <div class="conductor-recommendation-title">üéØ Conductor's Recommendation</div>
                  <div>${parts[1].trim()}</div>
                </div>
              `;
            } else {
              html += `<div class="message-summary">${formattedSummary}</div>`;
            }
          } else {
            html += `<div class="message-summary">${formattedSummary}</div>`;
          }
        }

        addMsg('conductor', html, true);

        // Update stats
        totalSpent += parseFloat(data.costs?.totalCost) || 0;
        queries++;
        document.getElementById('totalSpent').textContent = totalSpent.toFixed(2) + ' CRO';
        document.getElementById('queryCount').textContent = queries;
        await updateWalletUI();

      } catch (err) {
        removeTyping(typingId);
        if (err.code === 4001) {
          addMsg('conductor', 'Payment cancelled by user.');
        } else {
          addMsg('conductor', `Error: ${err.message}`);
        }
      }

      processing = false;
      document.getElementById('sendBtn').disabled = false;
    }

    // ============ UI HELPERS ============
    function getMetrics(r) {
      const m = [], d = r.data;
      if (!d) return m;
      if (r.agent === 'agent-arbitrage') {
        m.push({ label: 'Opportunities', value: d.analysis?.opportunitiesFound || 0, cls: d.analysis?.opportunitiesFound > 0 ? 'success' : '' });
        m.push({ label: 'Flash Loan', value: d.flashLoanOpportunity?.viable ? 'Yes' : 'No', cls: d.flashLoanOpportunity?.viable ? 'success' : '' });
      } else if (r.agent === 'agent-sentiment') {
        m.push({ label: 'Sentiment', value: d.sentiment?.label || 'N/A', cls: d.sentiment?.label === 'Bullish' ? 'success' : d.sentiment?.label === 'Bearish' ? 'error' : 'warning' });
        m.push({ label: 'Confidence', value: d.sentiment?.confidence || '0%' });
      } else if (r.agent === 'agent-risk') {
        m.push({ label: 'Sharpe', value: d.riskMetrics?.sharpeRatio?.value?.toFixed(2) || 'N/A' });
        m.push({ label: 'Risk', value: d.summary?.riskLevel || 'N/A' });
      } else if (r.agent === 'agent-audit') {
        const g = d.verdict?.grade || 'N/A';
        m.push({ label: 'Grade', value: g, cls: ['A','B'].includes(g) ? 'success' : g === 'C' ? 'warning' : 'error' });
        m.push({ label: 'Safe', value: d.verdict?.safeToInteract ? 'Yes' : 'No', cls: d.verdict?.safeToInteract ? 'success' : 'error' });
      } else if (r.agent === 'agent-executor') {
        m.push({ label: 'Best DEX', value: d.bestRoute?.dex || 'N/A' });
        m.push({ label: 'MEV Risk', value: d.mevProtection?.riskLevel || 'N/A' });
      }
      return m;
    }

    function addMsg(type, content, isHtml = false) {
      const c = document.getElementById('chatMessages');
      const el = document.createElement('div');
      el.className = `message ${type}`;
      el.innerHTML = `<div class="message-content">${isHtml ? content : esc(content)}</div>`;
      c.appendChild(el);
      c.scrollTop = c.scrollHeight;
    }

    function showTyping() {
      const c = document.getElementById('chatMessages');
      const el = document.createElement('div');
      el.className = 'message conductor';
      el.id = 'typing-' + Date.now();
      el.innerHTML = `<div class="typing-indicator"><div class="typing-dot"></div><div class="typing-dot"></div><div class="typing-dot"></div></div>`;
      c.appendChild(el);
      c.scrollTop = c.scrollHeight;
      return el.id;
    }

    function removeTyping(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    }

    function resetAgents() {
      document.querySelectorAll('.agent-mini').forEach(el => el.classList.remove('active', 'success'));
    }

    function setAgent(id, state) {
      const el = document.getElementById(`mini-${id.replace('agent-', '')}`);
      if (el) { el.classList.remove('active', 'success'); el.classList.add(state); }
    }

    function esc(t) {
      const d = document.createElement('div');
      d.textContent = t;
      return d.innerHTML;
    }

    // ============ INIT ============
    // Check if already connected
    if (window.ethereum && window.ethereum.selectedAddress) {
      walletAddress = window.ethereum.selectedAddress;
      isConnected = true;
      updateWalletUI();
    }
  </script>
</body>
</html>
